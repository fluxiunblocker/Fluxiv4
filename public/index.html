<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Docs</title>
    <link rel="icon" href="https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico">
</head>

<body>
    <p>Loading...</p>

    <script type="module">
        async function preRegisterServiceWorker() {
            if ("serviceWorker" in navigator) {
                try {
                    await navigator.serviceWorker.register("/sw.js", { scope: "/service/" });
                    return true;
                } catch (error) {
                    return false;
                }
            }
            return false;
        }

        async function openPopup() {
            try {
                await preRegisterServiceWorker();

                const serverOrigin = window.location.origin;

                const popup = window.open('about:blank', '_blank');

                if (popup) {
                    const htmlContent = '<!DOCTYPE html>' +
                        '<html>' +
                        '<head>' +
                        '    <meta charset="UTF-8">' +
                        '    <title>Fluxiv4</title>' +
                        '    <link rel="icon" href="' + serverOrigin + '/favicon.png">' +
                        '    <style>' +
                        '        * { margin: 0; padding: 0; box-sizing: border-box; }' +
                        '        html, body { width: 100%; height: 100%; overflow: hidden; }' +
                        '        iframe { width: 100%; height: 100%; border: none; }' +
                        '    </style>' +
                        '</head>' +
                        '<body>' +
                        '    <iframe id="main-frame" src="' + serverOrigin + '/main.html" allow="fullscreen"></iframe>' +
                        '    <script>' +
                        '        window.addEventListener("message", function(e) {' +
                        '            if (e.data && e.data.type === "uv-navigate") {' +
                        '                var frame = document.getElementById("main-frame");' +
                        '                if (frame && frame.contentWindow) {' +
                        '                    frame.contentWindow.postMessage(e.data, "*");' +
                        '                }' +
                        '            }' +
                        '        });' +
                        '    <\/script>' +
                        '</body>' +
                        '</html>';

                    popup.document.open();
                    popup.document.write(htmlContent);
                    popup.document.close();

                    window.location.replace('https://docs.google.com');
                } else {
                    alert('Popup blocked! Please allow popups for this site.');
                }
            } catch (error) {
                alert('Failed to open popup');
            }
        }

        window.onload = openPopup;
    </script>
</body>

</html>